{# ========================= _lead_edit_form.html ========================= #}

<style>
  /* Make the overlay a flex container so we can center the modal */
.modal-overlay {
  display: flex;               /* instead of display:none or block */
  align-items: center;         /* vertically center when content is shorter */
  justify-content: center;     /* horizontally center */
  padding: 1rem;               /* give it some breathing room on very small screens */
}

/* Constrain the modal box itself */
.modal-wrapper {
  max-height: 90vh;            /* never taller than 90% of the viewport */
  overflow-y: auto;            /* scroll internally if content is too tall */
}


</style>

<div class="modal-overlay">
  <div class="modal-wrapper">
    <div class="modal-header">
      <h2>Edit Lead #{{ lead.pk }}</h2>
      <button id="closeModal">&times;</button>
    </div>

    <form id="lead-edit-form" method="post" novalidate>
      {% csrf_token %}

      {# Loop over each visible field in the form #}
      {% for field in form.visible_fields %}
        <div class="form-group">
          <label for="{{ field.id_for_label }}">{{ field.label }}</label>
          {{ field }}
          {% if field.help_text %}
            <small class="help-text">{{ field.help_text }}</small>
          {% endif %}
          {% for err in field.errors %}
            <div style="color: crimson; margin-top: 0.25rem;">
              {{ err }}
            </div>
          {% endfor %}
        </div>
      {% endfor %}

      <div class="modal-actions">
        <button type="submit">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<script>
  (function() {
    // 1) Close button simply hides the overlay
    document.getElementById("closeModal").addEventListener("click", () => {
      document.querySelector(".modal-overlay").style.display = "none";
    });

    // 2) Intercept form submission to do AJAX POST
    document.getElementById("lead-edit-form").addEventListener("submit", async function(e) {
      e.preventDefault();
      const formEl = this;
      const url = "{% url 'leads:edit_form' lead.pk %}";
      const data = new FormData(formEl);

      const resp = await fetch(url, {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest" },
        body: data
      });

      // If JSON { "success": true } returned, close modal:
      try {
        const obj = await resp.json();
        if (obj.success) {
          document.querySelector(".modal-overlay").style.display = "none";
          return;
        }
      } catch (err) {
        // Not JSON → HTML with validation errors
      }

      // Otherwise, re‐inject returned HTML (with errors) into the same placeholder
      const newHtml = await resp.text();
      document.getElementById("leadModalContainer").innerHTML = newHtml;
      // The <script> block in the returned HTML re‐runs itself, re‐binding close and submit handlers.
    });
  })();
</script>